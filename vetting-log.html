<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Human Reset Project ‚Äî Vetting Log</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" />

  <style>
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f4f4;
      color: #222;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    header {
      position: sticky;
      top: 0;
      background: #ffffffcc;
      backdrop-filter: blur(6px);
      z-index: 1000;
      text-align: center;
      padding: 1rem 0.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    header h1 {
      font-size: 1.8rem;
      margin: 0.5rem 0;
      color: #0a3d62;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    nav { margin-top: 0.5rem; }

    nav a {
      color: #0a3d62;
      margin: 0 10px;
      font-weight: 600;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background-color 0.3s ease, color 0.3s ease;
      display: inline-block;
    }
    nav a:hover { background-color: #eaf4ee; color: #063b4d; }

    main {
      padding: 2rem 1rem 4rem;
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }

    .title {
      text-align: center;
      margin: 0;
      color: #0a3d62;
      font-size: 1.7rem;
    }

    .subtitle {
      text-align: center;
      margin: 0.75rem auto 0;
      max-width: 760px;
    }

    .subtitle em { font-style: italic; }

    /* ‚úÖ Quick filters */
    .quick-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-start;
      margin: 0.75rem 0 0.5rem;
    }

    .qbtn {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #d7e3dc;
      background: #f6fbf8;
      color: #0a3d62;
      cursor: pointer;
      transition: transform 0.05s ease, background-color 0.2s ease;
    }

    .qbtn:hover { background: #eaf4ee; }
    .qbtn:active { transform: translateY(1px); }

    .qbtn.active {
      background: #0a3d62;
      border-color: #0a3d62;
      color: #fff;
    }

    /* Controls row (dropdown) */
    .controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin: 0.75rem 0 0.5rem;
      flex-wrap: wrap;
    }

    .controls label {
      font-weight: 600;
      color: #0a3d62;
    }

    select {
      font-family: 'Inter', sans-serif;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #cfd8dc;
      background: #fff;
      color: #222;
      font-weight: 600;
    }

    table.dataTable thead th {
      background: #eaf4ee !important;
      color: #0a3d62 !important;
      font-weight: 700;
    }

    td.details-control {
      cursor: pointer;
      width: 26px;
      text-align: center;
      font-weight: 800;
      color: #0a3d62;
      user-select: none;
    }

    tr.no-children td.details-control { color: #c0c7cc; cursor: default; }

    .child-wrap {
      background: #f7f7f7;
      border-left: 4px solid #c0c7cc;
      padding: 12px 14px;
      border-radius: 8px;
    }

    .child-title { margin: 0 0 10px; color: #555; font-weight: 700; }

    .child-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .child-table th,
    .child-table td {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: top;
    }

    .muted { color: #666; }

    footer {
      text-align: center;
      background: #eaf4ee;
      padding: 1rem;
      font-size: 0.9rem;
      color: #444;
      margin-top: 2rem;
    }

    a { color: #0a3d62; }
  </style>
</head>
<body>
  <header id="top">
    <h1>üßæ Human Reset Project ‚Äî Vetting Log</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="supplements.html">Supplements</a>
      <a href="pet-wellness.html">Pet Wellness</a>
      <a href="cleaning.html">Cleaning</a>
      <a href="home-goods.html">Home Goods</a>
      <a href="oral-health.html">Oral Health</a>
      <a href="clothing.html">Clothing</a>
      <a href="vetting-log.html">üßæ Vetting Log</a>
      <a href="#top">Back to Top</a>
    </nav>
  </header>

  <main>
    <div class="card">
      <h2 class="title">Non-Toxic Product Vetting Log</h2>
      <p class="subtitle">
        Approved items are shown below. Click the little arrow (‚ñ∂) beside each product to
        <em>‚ÄúSee What Didn‚Äôt Make the Cut.‚Äù</em>
      </p>
    </div>

    <div class="card">
      <!-- ‚úÖ Quick Filters -->
      <div class="quick-filters" id="quickFilters">
        <button class="qbtn" data-main="__ALL__">All</button>
      <button class="qbtn" data-main="Oral Health">Oral Health</button>
        <button class="qbtn" data-main="Pet Care">Pet Care</button>
        <button class="qbtn" data-main="Cleaning">Cleaning</button>
        <button class="qbtn" data-main="Kitchen Appliances">Kitchen Appliances</button>
        <button class="qbtn" data-main="Kitchen & Tableware">Kitchen & Tableware</button>
      </div>

      <div class="controls">
        <label for="categoryFilter">Filter by Main Category:</label>
        <select id="categoryFilter">
          <option value="__ALL__">All</option>
        </select>
      </div>

      <table id="vettingTable" class="display" style="width:100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <footer>
    Created with üíö by Brandy ‚Äî Human Reset Project
  </footer>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const DISPLAY_COLUMNS = [
      "Main Category","Category","Status","Product / Model","Materials & Build",
      "Toxin Notes / Certifications","Reason for Decision","Price Range","Made In"
    ];

    const CHILD_COLUMNS = [
      "Status","Product / Model","Materials & Build","Toxin Notes / Certifications",
      "Reason for Decision","Price Range","Made In"
    ];

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function asLink(text, url) {
      const safeText = escapeHtml(text);
      const safeUrl = escapeHtml(url);
      if (!url) return safeText;
      return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeText}</a>`;
    }

    function formatChildRows(childRows) {
      let html = `<div class="child-wrap">
        <div class="child-title">See What Didn‚Äôt Make the Cut</div>
        <table class="child-table">
          <thead><tr>${CHILD_COLUMNS.map(c => `<th>${escapeHtml(c)}</th>`).join("")}</tr></thead>
          <tbody>`;
      childRows.forEach(r => {
        html += "<tr>";
        CHILD_COLUMNS.forEach(col => {
          let val = r[col] ?? "";
          if (col === "Product / Model") val = asLink(val, r["Link"]);
          else val = escapeHtml(val);
          html += `<td class="muted">${val}</td>`;
        });
        html += "</tr>";
      });
      html += `</tbody></table></div>`;
      return html;
    }

    function getMainParam() {
      const params = new URLSearchParams(window.location.search);
      const main = params.get("main");
      return main ? main.trim() : "";
    }

    function setActiveQuick(main) {
      document.querySelectorAll(".qbtn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.main === (main || "__ALL__"));
      });
    }

    Papa.parse("Non_Toxic_Product_Vetting_Log.csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const all = results.data || [];

        const rows = all
          .map(r => {
            const cleaned = {};
            Object.keys(r).forEach(k => cleaned[k.trim()] = (r[k] ?? "").trim());
            return cleaned;
          })
          .filter(r => (r["Status"] || "").toLowerCase() !== "under review");

        const approved = rows.filter(r => (r["Status"] || "").toLowerCase() === "approved");
        const rejected = rows.filter(r => (r["Status"] || "").toLowerCase() === "rejected");

        const rejectMap = new Map();
        rejected.forEach(r => {
          const key = `${r["Main Category"]}__${r["Category"]}`;
          if (!rejectMap.has(key)) rejectMap.set(key, []);
          rejectMap.get(key).push(r);
        });

        const parentData = approved.map(r => {
          const key = `${r["Main Category"]}__${r["Category"]}`;
          return { _children: rejectMap.get(key) || [], ...r };
        });

        document.querySelector("#vettingTable thead").innerHTML = `
          <tr><th></th>${DISPLAY_COLUMNS.map(c => `<th>${escapeHtml(c)}</th>`).join("")}</tr>
        `;

        document.querySelector("#vettingTable tbody").innerHTML = parentData.map(r => {
          const hasChildren = r._children && r._children.length > 0;
          const rowClass = hasChildren ? "" : "no-children";
          const cells = DISPLAY_COLUMNS.map(col => {
            let val = r[col] ?? "";
            if (col === "Product / Model") val = asLink(val, r["Link"]);
            else val = escapeHtml(val);
            return `<td>${val}</td>`;
          }).join("");

          return `<tr class="${rowClass}" data-has-children="${hasChildren ? "1" : "0"}">
            <td class="details-control">‚ñ∂</td>${cells}
          </tr>`;
        }).join("");

        const dt = $("#vettingTable").DataTable({
          dom: "lrtip",
          pageLength: 25,
          order: [],
          fixedHeader: true,
          columnDefs: [{ orderable: false, targets: 0 }]
        });

        const mainCatIndex = 1; // arrow col 0, main category 1

        // Populate dropdown
        const uniqueCats = new Set();
        parentData.forEach(r => { if (r["Main Category"]) uniqueCats.add(r["Main Category"]); });
        const filter = document.getElementById("categoryFilter");
        Array.from(uniqueCats).sort().forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          filter.appendChild(opt);
        });

        function applyFilter(val) {
          if (!val || val === "__ALL__") {
            filter.value = "__ALL__";
            dt.column(mainCatIndex).search("").draw();
            setActiveQuick("__ALL__");
            return;
          }
          filter.value = val;
          dt.column(mainCatIndex).search("^" + val.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "$", true, false).draw();
          setActiveQuick(val);
        }

        filter.addEventListener("change", () => applyFilter(filter.value === "__ALL__" ? "" : filter.value));

        // Quick filter buttons
        document.getElementById("quickFilters").addEventListener("click", (e) => {
          const btn = e.target.closest(".qbtn");
          if (!btn) return;
          const val = btn.dataset.main;
          // update URL without reloading
          const url = new URL(window.location.href);
          if (val === "__ALL__") url.searchParams.delete("main");
          else url.searchParams.set("main", val);
          window.history.replaceState({}, "", url);
          applyFilter(val === "__ALL__" ? "" : val);
        });

        // Auto-apply filter from URL
        const urlMain = getMainParam();
        if (urlMain) applyFilter(urlMain);
        else applyFilter("");

        // Expand/collapse
        $("#vettingTable tbody").on("click", "td.details-control", function() {
          const tr = $(this).closest("tr");
          const row = dt.row(tr);
          const hasChildren = tr.attr("data-has-children") === "1";
          if (!hasChildren) return;

          const rowIndex = row.index();
          const children = parentData[rowIndex]?._children || [];

          if (row.child.isShown()) {
            row.child.hide();
            tr.find("td.details-control").text("‚ñ∂");
          } else {
            row.child(formatChildRows(children)).show();
            tr.find("td.details-control").text("‚ñº");
          }
        });

        $("#vettingTable tbody tr").each(function() {
          const has = $(this).attr("data-has-children") === "1";
          if (!has) $(this).addClass("no-children");
        });
      },
      error: function(err) { console.error("CSV load error:", err); }
    });
  </script>
</body>
</html>
