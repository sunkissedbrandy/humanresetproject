<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Human Reset Project ‚Äî Vetting Log</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- PapaParse for reliable CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f4f4;
      color: #222;
      padding: 0;
      margin: 0;
      line-height: 1.6;
    }

    /* Sticky Header */
    header {
      position: sticky;
      top: 0;
      background: #ffffffcc;
      backdrop-filter: blur(6px);
      z-index: 1000;
      text-align: center;
      padding: 1rem 0.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    header h1 {
      font-size: 1.8rem;
      margin: 0.5rem 0;
      color: #0a3d62;
      font-weight: 800;
    }
    nav { margin-top: 0.5rem; }
    nav a {
      color: #0a3d62;
      margin: 0 10px;
      font-weight: 700;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background-color 0.25s ease, color 0.25s ease;
    }
    nav a:hover {
      background-color: #eaf4ee;
      color: #063b4d;
    }

    main {
      padding: 2rem 1rem 4rem;
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      margin-bottom: 1.5rem;
    }

    h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.6rem;
      color: #0a3d62;
      text-align: center;
      font-weight: 800;
    }

    .subtext {
      text-align: center;
      max-width: 900px;
      margin: 0.25rem auto 0;
      color: #333;
    }
    .subtext em { font-style: italic; }

    /* Controls Row */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin: 0 0 0.75rem 0;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .pill {
      border: 1px solid #cfe5d7;
      background: #f7fbf8;
      color: #0a3d62;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }
    .pill:hover { background: #eaf4ee; }
    .pill.active {
      background: #0a3d62;
      border-color: #0a3d62;
      color: #fff;
    }

    .dropdown-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      font-weight: 700;
      color: #0a3d62;
    }

    select {
      font-family: 'Inter', sans-serif;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #cfd8dc;
      background: #fff;
      min-width: 220px;
      font-weight: 600;
      color: #222;
    }

    /* DataTables polish */
    table.dataTable thead th {
      background: #eaf4ee !important;
      color: #0a3d62;
      font-weight: 800;
      border-bottom: 1px solid #cfe5d7 !important;
    }
    table.dataTable tbody td {
      vertical-align: middle;
    }

    /* Remove DataTables length control (Show X entries) */
    div.dataTables_length { display: none !important; }
    /* Keep search */
    div.dataTables_filter {
      float: left !important;
      text-align: left !important;
      margin: 0.5rem 0 0.75rem;
    }
    div.dataTables_filter input {
      border-radius: 10px;
      border: 1px solid #cfd8dc;
      padding: 8px 10px;
      font-family: 'Inter', sans-serif;
    }

    /* Details-control arrow cell */
    td.details-control {
      cursor: pointer;
      width: 28px;
      text-align: center;
      font-weight: 900;
      color: #0a3d62;
    }
    td.details-control.empty {
      cursor: default;
      color: transparent;
    }

    /* Child row styling */
    .child-wrap {
      background: #f6f7f8;
      border-radius: 12px;
      padding: 14px 14px 10px;
      border: 1px solid #e0e0e0;
    }
    .child-title {
      font-weight: 800;
      color: #0a3d62;
      margin-bottom: 10px;
    }
    .child-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }
    .child-table th, .child-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
      font-size: 0.95rem;
    }
    .child-table th {
      background: #eaf4ee;
      color: #0a3d62;
      font-weight: 800;
    }
    .badge-rejected {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f1f1f1;
      color: #555;
      font-weight: 800;
      font-size: 0.82rem;
      margin-right: 8px;
    }

    footer {
      text-align: center;
      background: #eaf4ee;
      padding: 1rem;
      font-size: 0.9rem;
      color: #444;
      margin-top: 2rem;
      border-top: 1px solid #d6eadf;
    }
    footer span { color: #0a3d62; font-weight: 700; }

    /* Make product links look nice */
    a { color: #0a3d62; text-decoration: underline; }
  </style>
</head>

<body>
  <header id="top">
    <h1>üßæ Human Reset Project ‚Äî Vetting Log</h1>
    <nav>
      <a href="index.html">üè† Home</a>
      <a href="#top">Back to Top</a>
    </nav>
  </header>

  <main>
    <section class="card">
      <h2>Non-Toxic Product Vetting Log</h2>
      <p class="subtext">
        Approved items are shown below. Click the little arrow (<strong>‚ñ∂</strong>) beside a product to
        <em>‚ÄúSee What Didn‚Äôt Make the Cut.‚Äù</em>
      </p>
    </section>

    <section class="card">
      <div class="controls">
        <div class="pill-row" id="pillRow"></div>

        <div class="dropdown-wrap">
          <label for="mainCatSelect">Filter by Main Category:</label>
          <select id="mainCatSelect">
            <option value="All" selected>All</option>
          </select>
        </div>
      </div>

      <table id="vettingTable" class="display" style="width:100%">
        <thead>
          <tr>
            <th></th>
            <th>Main Category</th>
            <th>Category</th>
            <th>Product</th>
            <th>Reason for Decision</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    Created with <span>üíö</span> by Brandy ‚Äî <span>Human Reset Project</span>
  </footer>

  <script>
    let dt;
    let rejectsByKey = {}; // key: Main||Category -> array of rejected rows

    function keyFor(main, category) {
      return `${main}||${category}`;
    }

    function setActivePill(value) {
      document.querySelectorAll('.pill').forEach(p => {
        p.classList.toggle('active', p.dataset.value === value);
      });
    }

    function applyMainCategoryFilter(value) {
      // Sync dropdown + pills
      document.getElementById('mainCatSelect').value = value;
      setActivePill(value);

      // Column index 1 = Main Category (because col 0 is arrow)
      if (value === 'All') {
        dt.column(1).search('').draw();
      } else {
        // exact match
        dt.column(1).search('^' + value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '$', true, false).draw();
      }
    }

    function buildChildHTML(rejectRows) {
      let html = `
        <div class="child-wrap">
          <div class="child-title">See What Didn‚Äôt Make the Cut</div>
          <table class="child-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody>
      `;

      rejectRows.forEach(r => {
        html += `
          <tr>
            <td><span class="badge-rejected">Rejected</span>${r.Product}</td>
            <td>${r["Reason for Decision"] || ""}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;
      return html;
    }

    async function loadCSV() {
      const url = 'Non_Toxic_Product_Vetting_Log.csv?v=' + Date.now(); // cache-bust
      const res = await fetch(url);
      const csvText = await res.text();

      const parsed = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true
      });

      const data = parsed.data || [];

      // Build reject map + approved list
      rejectsByKey = {};
      const approved = [];

      data.forEach(r => {
        const main = (r["Main Category"] || "").trim();
        const cat  = (r["Category"] || "").trim();
        const status = (r["Status"] || "").trim();
        const k = keyFor(main, cat);

        // Ensure fields exist
        r["Main Category"] = main;
        r["Category"] = cat;
        r["Status"] = status;

        if (status === "Rejected") {
          if (!rejectsByKey[k]) rejectsByKey[k] = [];
          rejectsByKey[k].push(r);
        } else if (status === "Approved") {
          approved.push(r);
        }
      });

      // Unique main categories for pills/dropdown
      const mainCats = Array.from(new Set(
        approved.map(r => r["Main Category"]).filter(Boolean)
      )).sort();

      // Build pills
      const pillRow = document.getElementById('pillRow');
      pillRow.innerHTML = '';

      const allPill = document.createElement('div');
      allPill.className = 'pill active';
      allPill.textContent = 'All';
      allPill.dataset.value = 'All';
      allPill.onclick = () => applyMainCategoryFilter('All');
      pillRow.appendChild(allPill);

      mainCats.forEach(mc => {
        const p = document.createElement('div');
        p.className = 'pill';
        p.textContent = mc;
        p.dataset.value = mc;
        p.onclick = () => applyMainCategoryFilter(mc);
        pillRow.appendChild(p);
      });

      // Build dropdown
      const sel = document.getElementById('mainCatSelect');
      sel.innerHTML = '<option value="All" selected>All</option>';
      mainCats.forEach(mc => {
        const opt = document.createElement('option');
        opt.value = mc;
        opt.textContent = mc;
        sel.appendChild(opt);
      });
      sel.onchange = (e) => applyMainCategoryFilter(e.target.value);

      // Build table rows for DataTables
      // Column 0 is the arrow cell; we decide if it has rejects based on main+category key
      const tableData = approved.map(r => {
        const k = keyFor(r["Main Category"], r["Category"]);
        const hasRejects = Array.isArray(rejectsByKey[k]) && rejectsByKey[k].length > 0;

        return {
          _hasRejects: hasRejects,
          _key: k,
          "Main Category": r["Main Category"],
          "Category": r["Category"],
          "Product": r["Product"] || "",
          "Reason for Decision": r["Reason for Decision"] || ""
        };
      });

      // Initialize DataTable
      dt = $('#vettingTable').DataTable({
        data: tableData,
        columns: [
          {
            data: null,
            orderable: false,
            className: 'details-control',
            defaultContent: '‚ñ∂',
            render: function(data, type, row) {
              return row._hasRejects ? '‚ñ∂' : '';
            }
          },
          { data: "Main Category" },
          { data: "Category" },
          { data: "Product" },
          { data: "Reason for Decision" }
        ],
        // show full list, no paging
        paging: false,
        info: false,
        lengthChange: false,
        searching: true,
        order: [[1, 'asc'], [2, 'asc'], [3, 'asc']],
        // let product HTML render as links
        columnDefs: [
          { targets: 0, width: "28px" },
          { targets: 3, render: function(data) { return data; } }
        ],
        drawCallback: function() {
          // Mark empty arrow cells so cursor doesn't tease people
          $('#vettingTable tbody tr').each(function() {
            const rowData = dt.row(this).data();
            const cell = $(this).find('td.details-control');
            if (rowData && !rowData._hasRejects) cell.addClass('empty');
            else cell.removeClass('empty');
          });
        }
      });

      // Expand/collapse handler
      $('#vettingTable tbody').off('click', 'td.details-control').on('click', 'td.details-control', function () {
        const tr = $(this).closest('tr');
        const row = dt.row(tr);
        const rowData = row.data();

        if (!rowData || !rowData._hasRejects) return;

        if (row.child.isShown()) {
          row.child.hide();
          tr.find('td.details-control').text('‚ñ∂');
        } else {
          const rej = rejectsByKey[rowData._key] || [];
          row.child(buildChildHTML(rej)).show();
          tr.find('td.details-control').text('‚ñº');
        }
      });

      // Default filter = All
      applyMainCategoryFilter('All');
    }

    loadCSV();
  </script>
</body>
</html>
