<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Human Reset Project ‚Äî Vetting Log</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" />

  <style>
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f4f4;
      color: #222;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    header {
      position: sticky;
      top: 0;
      background: #ffffffcc;
      backdrop-filter: blur(6px);
      z-index: 1000;
      text-align: center;
      padding: 1rem 0.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    header h1 {
      font-size: 1.8rem;
      margin: 0.5rem 0;
      color: #0a3d62;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    nav {
      margin-top: 0.5rem;
    }

    nav a {
      color: #0a3d62;
      margin: 0 10px;
      font-weight: 600;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    nav a:hover {
      background-color: #eaf4ee;
      color: #063b4d;
    }

    main {
      padding: 2rem 1rem 4rem;
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }

    .title {
      text-align: center;
      margin: 0;
      color: #0a3d62;
      font-size: 1.7rem;
    }

    .subtitle {
      text-align: center;
      margin: 0.75rem auto 0;
      max-width: 720px;
    }

    .subtitle em { font-style: italic; }

    /* Controls row (dropdown) */
    .controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin: 1rem 0 0.5rem;
      flex-wrap: wrap;
    }

    .controls label {
      font-weight: 600;
      color: #0a3d62;
    }

    select {
      font-family: 'Inter', sans-serif;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #cfd8dc;
      background: #fff;
      color: #222;
      font-weight: 600;
    }

    /* DataTables tweaks */
    table.dataTable thead th {
      background: #eaf4ee !important;
      color: #0a3d62 !important;
      font-weight: 700;
    }

    /* Row expand arrow column */
    td.details-control {
      cursor: pointer;
      width: 26px;
      text-align: center;
      font-weight: 800;
      color: #0a3d62;
      user-select: none;
    }

    tr.no-children td.details-control {
      color: #c0c7cc;
      cursor: default;
    }

    /* Rejections child content */
    .child-wrap {
      background: #f7f7f7;
      border-left: 4px solid #c0c7cc;
      padding: 12px 14px;
      border-radius: 8px;
    }

    .child-title {
      margin: 0 0 10px;
      color: #555;
      font-weight: 700;
    }

    .child-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .child-table th,
    .child-table td {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: top;
    }

    .muted {
      color: #666;
    }

    footer {
      text-align: center;
      background: #eaf4ee;
      padding: 1rem;
      font-size: 0.9rem;
      color: #444;
      margin-top: 2rem;
    }

    a { color: #0a3d62; }
  </style>
</head>
<body>
  <header id="top">
    <h1>üßæ Human Reset Project ‚Äî Vetting Log</h1>
    <nav>
      <a href="index.html">üè° Home</a>
      <a href="#top">Back to Top</a>
    </nav>
  </header>

  <main>
    <div class="card">
      <h2 class="title">Non-Toxic Product Vetting Log</h2>
      <p class="subtitle">
        This living log tracks everything I‚Äôve personally vetted ‚Äî from cookware to pet products.<br />
        Approved items are shown below. Click the little arrow (‚ñ∂) beside each product to
        <em>‚ÄúSee What Didn‚Äôt Make the Cut.‚Äù</em>
      </p>
    </div>

    <div class="card">
      <div class="controls">
        <label for="categoryFilter">Filter by Main Category:</label>
        <select id="categoryFilter">
          <option value="__ALL__">All</option>
        </select>
      </div>

      <table id="vettingTable" class="display" style="width:100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <footer>
    Created with üíö by Brandy ‚Äî Human Reset Project
  </footer>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

  <!-- PapaParse (correct CSV parsing, handles commas inside quotes) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Columns we will display in the main (Approved) table
    const DISPLAY_COLUMNS = [
      "Main Category",
      "Category",
      "Status",
      "Product / Model",
      "Materials & Build",
      "Toxin Notes / Certifications",
      "Reason for Decision",
      "Price Range",
      "Made In"
    ];

    // Columns we show inside the "Didn't Make the Cut" expandable area
    const CHILD_COLUMNS = [
      "Status",
      "Product / Model",
      "Materials & Build",
      "Toxin Notes / Certifications",
      "Reason for Decision",
      "Price Range",
      "Made In"
    ];

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function asLink(text, url) {
      const safeText = escapeHtml(text);
      const safeUrl = escapeHtml(url);
      if (!url) return safeText;
      return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeText}</a>`;
    }

    function formatChildRows(childRows) {
      let html = `<div class="child-wrap">
        <div class="child-title">See What Didn‚Äôt Make the Cut</div>
        <table class="child-table">
          <thead><tr>${CHILD_COLUMNS.map(c => `<th>${escapeHtml(c)}</th>`).join("")}</tr></thead>
          <tbody>
      `;

      childRows.forEach(r => {
        html += "<tr>";
        CHILD_COLUMNS.forEach(col => {
          let val = r[col] ?? "";
          if (col === "Product / Model") {
            val = asLink(val, r["Link"]);
          } else {
            val = escapeHtml(val);
          }
          html += `<td class="muted">${val}</td>`;
        });
        html += "</tr>";
      });

      html += "</tbody></table></div>";
      return html;
    }

    // Load CSV and build parent (approved) rows with expandable children (rejected)
    Papa.parse("Non_Toxic_Product_Vetting_Log.csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const all = results.data || [];

        // Normalize + remove Under Review completely (per your decision)
        const rows = all
          .map(r => {
            // Trim keys we care about
            const cleaned = {};
            Object.keys(r).forEach(k => cleaned[k.trim()] = (r[k] ?? "").trim());
            return cleaned;
          })
          .filter(r => (r["Status"] || "").toLowerCase() !== "under review");

        // Split approved vs rejected
        const approved = rows.filter(r => (r["Status"] || "").toLowerCase() === "approved");
        const rejected = rows.filter(r => (r["Status"] || "").toLowerCase() === "rejected");

        // Group rejects by (Main Category + Category)
        const rejectMap = new Map();
        rejected.forEach(r => {
          const key = `${r["Main Category"]}__${r["Category"]}`;
          if (!rejectMap.has(key)) rejectMap.set(key, []);
          rejectMap.get(key).push(r);
        });

        // Build parent table dataset
        // Each approved row becomes a parent; if any rejects share its (Main Category + Category), attach as children
        const parentData = approved.map(r => {
          const key = `${r["Main Category"]}__${r["Category"]}`;
          return {
            _children: rejectMap.get(key) || [],
            ...r
          };
        });

        // Build header with an extra first column for the expand arrow
        const thead = document.querySelector("#vettingTable thead");
        thead.innerHTML = `
          <tr>
            <th></th>
            ${DISPLAY_COLUMNS.map(c => `<th>${escapeHtml(c)}</th>`).join("")}
          </tr>
        `;

        // Build tbody
        const tbody = document.querySelector("#vettingTable tbody");
        tbody.innerHTML = parentData.map(r => {
          const hasChildren = r._children && r._children.length > 0;

          // First cell: arrow
          const arrowCell = hasChildren ? "‚ñ∂" : "‚ñ∂";
          const rowClass = hasChildren ? "" : "no-children";

          // Build visible cells
          const cells = DISPLAY_COLUMNS.map(col => {
            let val = r[col] ?? "";
            if (col === "Product / Model") {
              val = asLink(val, r["Link"]);
            } else {
              val = escapeHtml(val);
            }
            return `<td>${val}</td>`;
          }).join("");

          return `
            <tr class="${rowClass}" data-has-children="${hasChildren ? "1" : "0"}">
              <td class="details-control">${arrowCell}</td>
              ${cells}
            </tr>
          `;
        }).join("");

        // Init DataTable
        const dt = $("#vettingTable").DataTable({
          // IMPORTANT: remove built-in search box (no "f")
          dom: "lrtip",
          pageLength: 25,
          order: [],
          fixedHeader: true,
          columnDefs: [
            { orderable: false, targets: 0 } // arrow col not sortable
          ]
        });

        // Populate Main Category dropdown from visible parent rows
        const mainCatIndex = 1; // Because our arrow column is at index 0, Main Category is 1
        const uniqueCats = new Set();

        parentData.forEach(r => {
          if (r["Main Category"]) uniqueCats.add(r["Main Category"]);
        });

        const filter = document.getElementById("categoryFilter");
        Array.from(uniqueCats).sort().forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat;
          filter.appendChild(opt);
        });

        // Dropdown filter behavior (hides other categories)
        filter.addEventListener("change", () => {
          const val = filter.value;
          if (val === "__ALL__") {
            dt.column(mainCatIndex).search("").draw();
          } else {
            // exact match
            dt.column(mainCatIndex).search("^" + val.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "$", true, false).draw();
          }
        });

        // Expand/collapse child rows on arrow click
        $("#vettingTable tbody").on("click", "td.details-control", function() {
          const tr = $(this).closest("tr");
          const row = dt.row(tr);

          const hasChildren = tr.attr("data-has-children") === "1";
          if (!hasChildren) return;

          // Find matching parentData by visible row index
          const rowIndex = row.index();
          const rowDataObj = parentData[rowIndex];
          const children = rowDataObj?._children || [];

          if (row.child.isShown()) {
            row.child.hide();
            tr.find("td.details-control").text("‚ñ∂");
          } else {
            row.child(formatChildRows(children)).show();
            tr.find("td.details-control").text("‚ñº");
          }
        });

        // Make rows with no children look "disabled"
        $("#vettingTable tbody tr").each(function() {
          const has = $(this).attr("data-has-children") === "1";
          if (!has) $(this).addClass("no-children");
        });
      },
      error: function(err) {
        console.error("CSV load error:", err);
      }
    });
  </script>
</body>
</html>

