<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Human Reset Project ‚Äî Vetting Log</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- DataTables + FixedHeader -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: #f4f4f4;
      color: #222;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #ffffffcc;
      backdrop-filter: blur(6px);
      text-align: center;
      padding: 1rem 0.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.06);
    }

    header h1 {
      margin: 0.25rem 0 0.5rem;
      color: #0a3d62;
      font-size: 1.8rem;
      font-weight: 800;
    }

    nav {
      margin-top: 0.5rem;
    }

    nav a {
      color: #0a3d62;
      margin: 0 10px;
      font-weight: 700;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 8px;
      transition: background-color 0.25s ease, color 0.25s ease;
    }

    nav a:hover {
      background-color: #eaf4ee;
      color: #063b4d;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1rem 4rem;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.06);
      margin-bottom: 1.5rem;
    }

    .hero {
      text-align: center;
    }

    .hero h2 {
      margin: 0.25rem 0 0.5rem;
      color: #0a3d62;
      font-size: 1.8rem;
    }

    .hero p {
      margin: 0;
      color: #333;
      line-height: 1.6;
    }

    /* Controls row */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.75rem;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .pill {
      border: 1px solid #cfe4d6;
      background: #f3faf6;
      color: #0a3d62;
      padding: 0.45rem 0.8rem;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: transform 0.08s ease, background 0.2s ease;
      font-size: 0.95rem;
    }

    .pill:hover { background: #eaf4ee; }
    .pill:active { transform: translateY(1px); }

    .pill.active {
      background: #0a3d62;
      color: white;
      border-color: #0a3d62;
    }

    .right-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-end;
    }

    label {
      font-weight: 700;
      color: #0a3d62;
      white-space: nowrap;
    }

    select, input[type="text"] {
      border: 1px solid #cfd8dc;
      border-radius: 10px;
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 0.95rem;
      background: #fff;
      outline: none;
    }

    input[type="text"] {
      width: 240px;
    }

    /* DataTables table */
    table.dataTable thead th {
      background: #eaf4ee !important;
      color: #0a3d62 !important;
      font-weight: 800;
      border-bottom: 1px solid #cfe4d6 !important;
    }

    table.dataTable tbody td {
      vertical-align: middle;
    }

    /* Arrow column */
    td.dt-control {
      cursor: pointer;
      width: 28px;
      text-align: center;
      color: #0a3d62;
      font-weight: 900;
      user-select: none;
    }

    /* Child row box */
    .child-wrap {
      background: #f7f7f7;
      border: 1px solid #e1e1e1;
      border-radius: 12px;
      padding: 1rem;
      margin: 0.5rem 0;
    }

    .child-title {
      font-weight: 800;
      color: #0a3d62;
      margin-bottom: 0.75rem;
    }

    .mini-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }

    .mini-table th, .mini-table td {
      padding: 0.65rem 0.75rem;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
    }

    .mini-table th {
      background: #eaf4ee;
      color: #0a3d62;
      font-weight: 800;
    }

    .badge-reject {
      display: inline-block;
      font-weight: 800;
      font-size: 0.85rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: #f2dede;
      color: #8a1f1f;
      margin-right: 0.5rem;
      white-space: nowrap;
    }

    footer {
      text-align: center;
      background: #eaf4ee;
      padding: 1rem;
      font-size: 0.9rem;
      color: #444;
      margin-top: 2rem;
    }

    a { color: #0a3d62; }
  </style>
</head>

<body>
  <header>
    <h1>üßæ Human Reset Project ‚Äî Vetting Log</h1>
    <nav>
      <a href="index.html">üè° Home</a>
      <a href="#top">Back to Top</a>
    </nav>
  </header>

  <main id="top">
    <section class="card hero">
      <h2>Non-Toxic Product Vetting Log</h2>
      <p>
        Approved items are shown below. Click the little arrow (‚ñ∂) beside each product to
        <em>‚ÄúSee What Didn‚Äôt Make the Cut.‚Äù</em>
      </p>
    </section>

    <section class="card">
      <div class="controls">
        <div class="btn-row" id="categoryButtons"></div>

        <div class="right-controls">
          <div>
            <label for="mainCategorySelect">Filter by Main Category:&nbsp;</label>
            <select id="mainCategorySelect">
              <option value="All">All</option>
            </select>
          </div>

          <div>
            <label for="searchBox">Search:&nbsp;</label>
            <input id="searchBox" type="text" placeholder="Type to search‚Ä¶" />
          </div>
        </div>
      </div>

      <div style="margin-top: 1rem;">
        <table id="vettingTable" class="display" style="width:100%">
          <thead>
            <tr>
              <th></th>
              <th>Main Category</th>
              <th>Category</th>
              <th>Product</th>
              <th>Reason for Decision</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    Created with üíö by Brandy ‚Äî Human Reset Project
  </footer>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

  <script>
    // Robust CSV parser (handles commas inside quotes)
    function parseCSV(csvText) {
      const rows = [];
      let row = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const next = csvText[i + 1];

        if (char === '"' && inQuotes && next === '"') {
          current += '"';
          i++;
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          row.push(current);
          current = "";
        } else if ((char === '\n' || char === '\r') && !inQuotes) {
          if (char === '\r' && next === '\n') i++;
          row.push(current);
          if (row.some(cell => cell.trim() !== "")) rows.push(row);
          row = [];
          current = "";
        } else {
          current += char;
        }
      }

      row.push(current);
      if (row.some(cell => cell.trim() !== "")) rows.push(row);

      return rows;
    }

    function safeText(s) {
      return (s || "").toString().trim();
    }

    function buildChild(rejectedRows) {
      if (!rejectedRows || rejectedRows.length === 0) return "";

      let html = `
        <div class="child-wrap">
          <div class="child-title">See What Didn‚Äôt Make the Cut</div>
          <table class="mini-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Reason for Decision</th>
              </tr>
            </thead>
            <tbody>
      `;

      rejectedRows.forEach(r => {
        html += `
          <tr>
            <td><span class="badge-reject">Rejected</span>${r.product}</td>
            <td>${r.reason}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      return html;
    }

    async function loadVettingLog() {
      const response = await fetch("Non_Toxic_Product_Vetting_Log.csv");
      const csvText = await response.text();

      const rows = parseCSV(csvText);
      const headers = rows.shift().map(h => safeText(h));

      // Expected: Main Category, Category, Status, Product, Reason for Decision
      const idx = (name) => headers.indexOf(name);

      const iMain = idx("Main Category");
      const iCat = idx("Category");
      const iStatus = idx("Status");
      const iProduct = idx("Product");
      const iReason = idx("Reason for Decision");

      // Build data objects
      const all = rows.map(r => ({
        main: safeText(r[iMain]),
        cat: safeText(r[iCat]),
        status: safeText(r[iStatus]),
        product: (r[iProduct] || "").toString().trim(),
        reason: safeText(r[iReason])
      })).filter(x => x.main || x.cat || x.product);

      // Group by (Main Category + Category) so approved rows can hide rejected rows under arrow
      const groups = new Map();
      all.forEach(item => {
        const key = `${item.main}|||${item.cat}`;
        if (!groups.has(key)) groups.set(key, { approved: [], rejected: [] });

        if (item.status.toLowerCase() === "rejected") groups.get(key).rejected.push(item);
        else groups.get(key).approved.push(item); // treat anything else as approved-visible
      });

      // Flatten into rows for main table: only approved items appear as main rows
      const mainRows = [];
      groups.forEach((g, key) => {
        g.approved.forEach(a => {
          mainRows.push({
            main: a.main,
            cat: a.cat,
            product: a.product,
            reason: a.reason,
            rejectedChildren: g.rejected.map(r => ({
              product: r.product,
              reason: r.reason
            }))
          });
        });
      });

      // Populate dropdown + buttons
      const uniqueMainCats = Array.from(new Set(mainRows.map(x => x.main))).sort();

      const select = document.getElementById("mainCategorySelect");
      uniqueMainCats.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });

      const btnWrap = document.getElementById("categoryButtons");

      function makeButton(label) {
        const btn = document.createElement("button");
        btn.className = "pill";
        btn.type = "button";
        btn.textContent = label;
        btn.dataset.value = label;
        return btn;
      }

      const allBtn = makeButton("All");
      allBtn.classList.add("active");
      btnWrap.appendChild(allBtn);

      uniqueMainCats.forEach(c => btnWrap.appendChild(makeButton(c)));

      // Render table body
      const tbody = document.querySelector("#vettingTable tbody");
      tbody.innerHTML = "";
      mainRows.forEach(row => {
        const hasChildren = row.rejectedChildren && row.rejectedChildren.length > 0;
        const arrow = hasChildren ? "‚ñ∂" : "";

        const tr = document.createElement("tr");
        tr.dataset.main = row.main;
        tr.dataset.haschildren = hasChildren ? "1" : "0";
        tr.innerHTML = `
          <td class="dt-control">${arrow}</td>
          <td>${row.main}</td>
          <td>${row.cat}</td>
          <td>${row.product}</td>
          <td>${row.reason}</td>
        `;

        // stash child HTML
        tr._childHTML = hasChildren ? buildChild(row.rejectedChildren) : "";
        tbody.appendChild(tr);
      });

      // Init DataTable (NO paging + NO length menu)
      const dt = $("#vettingTable").DataTable({
        // no built-in length dropdown, no paging controls, keep the table only
        dom: "rt",
        paging: false,
        info: false,
        order: [],
        fixedHeader: true,
        columnDefs: [
          { orderable: false, targets: 0 }
        ]
      });

      // Custom search box
      const searchBox = document.getElementById("searchBox");
      searchBox.addEventListener("input", () => {
        dt.search(searchBox.value).draw();
      });

      // Dropdown filter
      select.addEventListener("change", () => {
        const val = select.value;
        setActiveButton(val);
        if (val === "All") dt.column(1).search("").draw();
        else dt.column(1).search("^" + escapeRegex(val) + "$", true, false).draw();
      });

      function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      function setActiveButton(val) {
        document.querySelectorAll(".pill").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".pill").forEach(b => {
          if (b.dataset.value === val) b.classList.add("active");
        });
      }

      // Button filter
      btnWrap.addEventListener("click", (e) => {
        const btn = e.target.closest(".pill");
        if (!btn) return;

        const val = btn.dataset.value;
        select.value = val; // sync dropdown
        setActiveButton(val);

        if (val === "All") dt.column(1).search("").draw();
        else dt.column(1).search("^" + escapeRegex(val) + "$", true, false).draw();
      });

      // Expand/collapse rejected rows
      $("#vettingTable tbody").on("click", "td.dt-control", function () {
        const tr = $(this).closest("tr");
        const row = dt.row(tr);

        // no children
        if (tr[0].dataset.haschildren !== "1") return;

        if (row.child.isShown()) {
          row.child.hide();
          $(this).text("‚ñ∂");
        } else {
          row.child(tr[0]._childHTML).show();
          $(this).text("‚ñº");
        }
      });
    }

    loadVettingLog();
  </script>
</body>
</html>
